# LockTower

Lock Tower is an implementation of Nakomoto Consensus with time based locks. It satisfies the following properties:

* if the nodes share a common ancestor then they will converge to a branch containing that ancestor no matter how they are partitioned.

* rollback requires exponentially more time for older votes then for newer votes.

* Nodes can independently configure how much convergence in voting they would like to see before committing a vote to a higher lockout.  This allows each node to make a trade-off of risk and reward.

## Time

For networks like Solana time can be the PoH hash count (which is a VDF) as it is generated by the network.  Networks that can use an external source of time can rely on that source. 

## Algorithm

The basic idea to this approach is to stack consensus votes.  Each consensus vote has a "lockout" before it can be switched.  When a vote is added to the stack the lockouts of all the votes in the stack are doubled.  With each new vote a node commits the previous votes to a ever increasing lockout.  Since at 32 votes we can consider the system to be at `max lockout` any votes with a lockout above 1<<32 are dequeued.


### Rollback

Before a vote is pushed to the stack, all the votes leading up to vote with a lower lock time then the new vote are purged.

After rollback lockouts are not doubled until the node catches up to the rollback height of votes.

For example, a vote stack with the following state:
```
vote time | lockout | lock time
-------------------------------
        4 |      2  |         6
        3 |      4  |         7
        2 |      8  |        10
        1 |      16 |        l7
```
If the next vote is at time 9 the resulting state will be
```
vote time | lockout | lock time
-------------------------------
        9 |      2  |        11
        2 |      8  |        10
        1 |      16 |        l7
```                              
Next vote is at time 10
```
vote time | lockout | lock time
-------------------------------
       10 |      2  |        12
        9 |      4  |        13
        2 |      8  |        10
        1 |      16 |        l7
```                               
At this point the new votes caught up to the previous votes.  But, the vote at time 2 expires at 10, so when the next vote is applied the entire stack will unroll.
```
vote time | lockout | lock time
-------------------------------
       11 |      2  |        13
        1 |      16 |        l7
```                                
